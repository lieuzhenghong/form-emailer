<!DOCTYPE html>
<meta charset='utf-8'>
<title>Auto-emailer</title>
<style>
    html, body{
        padding:0;
        margin: 0;
    }
    body {
    }
    #wrapper {
        margin: 0 auto;
        max-width: 600px;
        border: 5px solid orange;
        text-align: center;
    }
    label {
        display: block;
    }
    input {
        display: block;
        border: 2px solid grey;
        width: 300px;
        height: 50px;
        margin: 5px auto;
    }
    #info {
        text-align: left;
    }
</style>
<body>
<div id='wrapper'>
    <h1>iGlobe 自動電郵系統</h1>
    <p> 請確保所有的附件都在 ./attachments/ 文件夾里。</p>
        <label for='email'>Email address</label>
        <input id ='email' type='email' placeholder='research@iglobepartners.com' required></input>
        <label for='password'>Password</label>
        <input id ='password' type='password' placeholder='Password' required></input>
        <label for='csv'>.csv filename</label>
        <input id ='csv' type='text' placeholder='data' value='data'></input>
        <label for='body'>.txt Text file filename</label>
        <input id ='body' type='text' placeholder='email' value='email'></input>
        Preview each email before sending:<input id='preview' checked type='checkbox'></input>
        <button value='Send emails' onclick='send()'>Send</button>

    <div id='info'>
        <h2>Email preview</h2>
    </div>
</div>
</body>

<script type='text/javascript'>
    function send() {
        var email = document.getElementById('email').value;
        var password = document.getElementById('password').value;
        var csv = document.getElementById('csv').value;
        var body = document.getElementById('body').value;
        var preview = document.getElementById('preview').checked;
        str = `/send?email=${email}&pw=${password}&data=${csv}&body=${body}&preview=${preview}`;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://127.0.0.1:5000' + str);
        xhr.onload = (e) => {
            if (xhr.readyState === 4) {
                try {
                    j = JSON.parse(xhr.responseText);
                } catch (e) {
                    document.getElementById('info').innerHTML = xhr.responseText;
                }
                console.log(j);
                e = '<h2>Email preview</h2>';
                for (let item of j) {
                    e += `<hr>`;
                    e += `<h3>${item.subject}</h3>`;
                    e += `<ul>`;
                    e += `<li>from: ${item.from}`;
                    e += `<li>to: ${item.to}`;
                    e += `<li>cc: ${item.cc}`;
                    e += `</ul>`;
                    e += `<p>${item.body}`;
                }
                document.getElementById('info').innerHTML = e;
            }
        }
        if (email !== '' && password !== '') {
            console.log('sending');
            xhr.send();
        }
    }
</script>
